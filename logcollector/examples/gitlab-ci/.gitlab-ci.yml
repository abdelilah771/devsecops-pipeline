# GitLab CI configuration that sends logs to your server
# Place this file in the root of your repository as .gitlab-ci.yml

variables:
  LOGMINER_URL: "https://YOUR_NGROK_URL.ngrok.io/logs/gitlab"

stages:
  - build
  - test
  - deploy
  - report

build:
  stage: build
  image: node:18
  script:
    - echo "Installing dependencies..."
    - npm install
    - echo "Building project..."
    - npm run build
  artifacts:
    paths:
      - dist/
      - node_modules/
    expire_in: 1 hour
  after_script:
    - |
      # Send build logs
      curl -X POST ${LOGMINER_URL} \
        -H "Content-Type: application/json" \
        -d "{
          \"log_data\": {
            \"stage\": \"build\",
            \"job_name\": \"${CI_JOB_NAME}\",
            \"job_status\": \"${CI_JOB_STATUS}\",
            \"pipeline_id\": \"${CI_PIPELINE_ID}\",
            \"commit_sha\": \"${CI_COMMIT_SHA}\",
            \"commit_message\": \"${CI_COMMIT_MESSAGE}\",
            \"branch\": \"${CI_COMMIT_BRANCH}\"
          },
          \"repo_name\": \"${CI_PROJECT_PATH}\",
          \"author\": \"${GITLAB_USER_LOGIN}\",
          \"pipeline_name\": \"Build Stage\",
          \"run_id\": \"${CI_PIPELINE_ID}\",
          \"timestamp_original\": \"${CI_PIPELINE_CREATED_AT}\"
        }"

test:
  stage: test
  image: node:18
  dependencies:
    - build
  script:
    - echo "Running tests..."
    - npm test
  allow_failure: true
  after_script:
    - |
      # Send test logs
      curl -X POST ${LOGMINER_URL} \
        -H "Content-Type: application/json" \
        -d "{
          \"log_data\": {
            \"stage\": \"test\",
            \"job_name\": \"${CI_JOB_NAME}\",
            \"job_status\": \"${CI_JOB_STATUS}\",
            \"pipeline_id\": \"${CI_PIPELINE_ID}\"
          },
          \"repo_name\": \"${CI_PROJECT_PATH}\",
          \"author\": \"${GITLAB_USER_LOGIN}\",
          \"pipeline_name\": \"Test Stage\",
          \"run_id\": \"${CI_PIPELINE_ID}\",
          \"timestamp_original\": \"${CI_PIPELINE_CREATED_AT}\"
        }"

deploy:
  stage: deploy
  script:
    - echo "Deploying application..."
    - echo "Deploy completed"
  only:
    - main
  after_script:
    - |
      # Send deployment logs
      curl -X POST ${LOGMINER_URL} \
        -H "Content-Type: application/json" \
        -d "{
          \"log_data\": {
            \"stage\": \"deploy\",
            \"job_name\": \"${CI_JOB_NAME}\",
            \"job_status\": \"${CI_JOB_STATUS}\",
            \"environment\": \"production\"
          },
          \"repo_name\": \"${CI_PROJECT_PATH}\",
          \"author\": \"${GITLAB_USER_LOGIN}\",
          \"pipeline_name\": \"Deploy Stage\",
          \"run_id\": \"${CI_PIPELINE_ID}\",
          \"timestamp_original\": \"${CI_PIPELINE_CREATED_AT}\"
        }"

# Final report job that always runs
pipeline_report:
  stage: report
  when: always
  script:
    - echo "Pipeline completed with status: ${CI_PIPELINE_STATUS}"
  after_script:
    - |
      # Send final pipeline summary
      curl -X POST ${LOGMINER_URL} \
        -H "Content-Type: application/json" \
        -d "{
          \"log_data\": {
            \"stage\": \"final_report\",
            \"pipeline_status\": \"${CI_PIPELINE_STATUS}\",
            \"pipeline_id\": \"${CI_PIPELINE_ID}\",
            \"pipeline_url\": \"${CI_PIPELINE_URL}\",
            \"duration\": \"${CI_PIPELINE_DURATION}\"
          },
          \"repo_name\": \"${CI_PROJECT_PATH}\",
          \"author\": \"${GITLAB_USER_LOGIN}\",
          \"pipeline_name\": \"Pipeline Summary\",
          \"run_id\": \"${CI_PIPELINE_ID}\",
          \"timestamp_original\": \"${CI_PIPELINE_CREATED_AT}\"
        }"
