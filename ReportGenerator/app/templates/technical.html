{% extends "base.html" %}

{% block title %}Security Assessment Report - {{ request.project_name }}{% endblock %}

{% block header %}
<div class="header-container">
    <h1>Security Assessment Report</h1>
    <p class="subtitle">Prepared by DevSecOps Pipeline • {{ request.triggered_by }} • {{ request.run_id }}</p>
</div>
{% endblock %}

{% block content %}
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; }
    h2 { border-bottom: 2px solid #2c3e50; padding-bottom: 10px; color: #2c3e50; margin-top: 30px; }
    .chart-container { display: flex; justify-content: space-around; margin: 20px 0; background: #f9f9f9; padding: 20px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #2c3e50; color: white; }
    tr:hover { background-color: #f5f5f5; }
    .severity-CRITICAL { color: #d32f2f; font-weight: bold; }
    .severity-HIGH { color: #f57c00; font-weight: bold; }
    .severity-MEDIUM { color: #fbc02d; font-weight: bold; }
    .severity-LOW { color: #388e3c; font-weight: bold; }
    .fix-box { background-color: #e8f5e9; padding: 10px; border-left: 5px solid #4caf50; margin-top: 5px; border-radius: 4px; }
    .description-box { margin-bottom: 10px; line-height: 1.5; }
    .metric-box { text-align: center; padding: 15px; background: #fff; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: 15%; }
    .metrics-row { display: flex; justify-content: space-between; margin-bottom: 20px; }
</style>

<h2>Executive Summary</h2>
<p>
    This technical report outlines the security vulnerabilities detected during the automated analysis of <strong>{{ request.project_name }}</strong>. 
    The assessment identified a total of <strong>{{ request.metrics.total_vulnerabilities }}</strong> issues. 
    Immediate attention is recommended for Critical and High severity findings to mitigate potential exploitation risks.
</p>

<div class="metrics-row">
    <div class="metric-box" style="border-top: 5px solid #d32f2f;"><strong>Critical</strong><br>{{ request.metrics.critical_count }}</div>
    <div class="metric-box" style="border-top: 5px solid #f57c00;"><strong>High</strong><br>{{ request.metrics.high_count }}</div>
    <div class="metric-box" style="border-top: 5px solid #fbc02d;"><strong>Medium</strong><br>{{ request.metrics.medium_count }}</div>
    <div class="metric-box" style="border-top: 5px solid #388e3c;"><strong>Low</strong><br>{{ request.metrics.low_count }}</div>
    <div class="metric-box" style="border-top: 5px solid #1976d2;"><strong>Score</strong><br>{{ request.metrics.security_score }}/10</div>
</div>

<h2>Visual Analysis</h2>
<div class="chart-container">
    {% if pie_chart %}
    <div>
        <h4 style="text-align:center">Severity Distribution</h4>
        <img src="data:image/png;base64,{{ pie_chart }}" alt="Severity Distribution" width="300">
    </div>
    {% endif %}
    {% if bar_chart %}
    <div>
        <h4 style="text-align:center">Vulnerabilities by Category</h4>
        <img src="data:image/png;base64,{{ bar_chart }}" alt="Category Distribution" width="400">
    </div>
    {% endif %}
</div>

<h2>Detailed Findings & Remediation</h2>
<p>The following table provides a granular view of each detected vulnerability, including affected components, specific locations, and expert remediation proposals.</p>

<table border="0">
    <thead>
        <tr>
            <th width="10%">Severity</th>
            <th width="15%">Category</th>
            <th width="20%">Component</th>
            <th width="55%">Details & Remediation</th>
        </tr>
    </thead>
    <tbody>
        {% for vuln in vulnerabilities %}
        <tr>
            <td class="severity-{{ vuln.severity }}">{{ vuln.severity }}</td>
            <td>{{ vuln.category }}</td>
            <td>{{ vuln.affected_component }}<br><small>Line: {{ vuln.line_number }}</small></td>
            <td>
                <div class="description-box">
                    <strong>Observation:</strong><br>
                    {{ vuln.description }}
                </div>
                {% if vuln.fix_suggestion %}
                <div class="fix-box">
                    <strong>Recommended Fix:</strong><br>
                    {{ vuln.fix_suggestion }}
                </div>
                {% else %}
                <div class="fix-box" style="border-left-color: #999; background-color: #f0f0f0;">
                    <em>No automated fix proposal available. Manual review required.</em>
                </div>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h2>Conclusion</h2>
<p>
    The security posture of this application requires improvements in the highlighted areas. 
    It is advised to prioritize the remediation of Critical and High severity issues before the next release cycle.
    Continuous monitoring and automated scanning should be maintained to prevent regression.
</p>
{% endblock %}